<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>客流到场趋势</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/passenger.css">
</head>
<body class="bg">
    <div class="container">
        <div class="header">
            <div class="title">客流到场趋势</div>
            <div class="logo">万达商业年会</div>
        </div>
        <div class="legend">
            <div class="legend-item" style="width: 30%;">
                <div class="legend-bar legend-bar-orange"></div>
                <h2>客流峰值时段</h2>
                <p id="shiduan"></p>
            </div>
            <div class="legend-item" style="width: 18%;">
                <h2>峰值客流占比</h2>
                <p id="fengzhi">0%</p>
            </div>
            <div class="legend-item" style="width: 15%;">
                <div class="legend-bar legend-bar-new"></div>
                <h2>新客客流</h2>
                <p id="xinke">0%</p>
            </div>
            <div class="legend-item" style="width: 15%;">
                <div class="legend-bar legend-bar-old"></div>
                <h2>老客客流</h2>
                <p id="laoke">0%</p>
            </div>
        </div>

        <div class="area-container">
            <span class="decrator light-bar-h" style="left:10%"></span>
            <span class="decrator light-bar-h" style="left:40%"></span>
            <span class="decrator light-bar-h" style="left:84%"></span>
            <span class="decrator light-bar-v" style="top:10%"></span>
            <span class="decrator light-bar-v" style="top:20%;right:0;"></span>
            <span class="spline-bottom"><span class="decrator"></span></span>
            <span class="spline-left-new"></span>
            <span class="spline-left-old"></span>
            <span class="decrator mark"></span>

            <div id="area-spline"></div>
        </div>

        <div class="scan-bar"></div>

    </div>

<script src="./js/jquery.min.js"></script>
<script src="./js/highcharts.js"></script>
<script>
    $(function () {
        zoom();
        window.onresize = function() {
            zoom();
        };

        loadData();
        setInterval(function(){
            loadData();
        }, 1000 * 60 * 10);

        function loadData() {
            $.get('http://54.222.253.178:9000/custom/flowgauge', function(data){
                if (data.length == 0) {
                    return false;
                }
                data = prepareData(data);
                var max = '';
                var fengzhi = 0;
                for (var i = 0; i < data.length; i++) {
                    if (data[i].new + data[i].old > fengzhi) {
                        fengzhi = data[i].new + data[i].old
                        max = data[i].time + ':00';
                    }
                }
                drawChart(data, max);
                pretty(data);
            }, 'json');
        }

        function zoom() {
            var width = $(window).width();
            var height = $(window).height();
            if (height > width) {
                $('html').css({zoom: width / 1080});
                $('html').height(1080);
                $('html').css({top: '-1080px'});
            } else {
                $('html').css({zoom: width / 1920});
            }
        }

        function prepareData(data) {
            var total = 0;
            var fengzhi = 0;
            var xinke = 0;
            var max = 0;
            var index = 0;
            for (var i = 0; i < data.length; i++) {
                total = total + data[i].new + data[i].old;
                xinke = xinke + data[i].new;
                if (data[i].new + data[i].old > fengzhi) {
                    fengzhi = data[i].new + data[i].old;
                    index = i;
                }
                max = Math.max(max, data[i].new, data[i].old);
            }

            $('#fengzhi').text(Math.round(fengzhi / total * 100) + '%');
            $('#xinke').text(Math.round(xinke / total * 100) + '%');
            $('#laoke').text(100 - Math.round(xinke / total * 100) + '%');
            $('.decrator.mark').css({left: index * 10 + '%'});
            var to = parseInt(data[index].time) + 1;
            if (to < 10) {
                to = '0' + to;
            }
            $('#shiduan').text(data[index].time + ':00~' + to + ':00');

            for (var i = 0; i < data.length; i++) {
                data[i].new = data[i].new / max * 0.8;
                data[i].old = data[i].old / max * 0.8;
            }
            data.unshift(data[0]);  //todo 返回数据中没有则添加，如果有则去掉这句
            return data;
        }

        function pretty(data) {
            var newLength = 0;
            var oldLength = 0;
            for (var i = 0; i < data.length; i++) {
                if (data[i].time == '09:00') {
                    newLength = data[i].new * 100 + '%';
                    oldLength = 0;
                }
            }
            $('.spline-bottom').width((data.length-3) * 10 + 5 + '%');
            $('.spline-left-new').height(newLength);
            $('.spline-left-old').height(oldLength);
            setTimeout(function(){
                $('.decrator').show();
            }, 200);
        }

        function drawChart(data, max) {
            var categories = [];
            var dataNew = [];
            var dataOld = [];
            for (var i = 0; i < data.length; i++) {
                categories.push(data[i].time + ':00');
                dataNew.push(data[i].new);
                dataOld.push(data[i].old);
            }
            categories.pop();
            return $('#area-spline').highcharts({
                chart: {
                    type: 'areaspline',
                    height: 481,
                    backgroundColor: 'rgba(0, 105, 224, 0.3)',
                    spacing: [0, 0, 0, 0]
                },
                title: {
                    text: ''
                },
                legend: {
                    enabled: false
                },
                xAxis: {
                    gridLineWidth: 2,
                    gridLineColor: '#0a3382',
                    lineWidth: 0,
                    tickLength: 0,
                    min: 0,
                    max: 9,
                    labels: {
                        y: -20,
                        style: {
                            fontFamily: 'Roboto',
                            fontWeight: 'lighter',
                            color: '#fff',
                            fontSize: '3.6rem'
                        },
                        formatter: function(){
                            if (this.value == max) {
                                this.value = '<span style="font-family: Roboto">' + this.value + '</span>';
                            }
                            if (categories.indexOf(this.value) == -1) {
                                this.value = '<span style="color:#a4aec9;">' + this.value + '</span>'
                            }
                            return this.value;
                        },
                        zIndex: 20
                    },
                    categories: [
                        '09:00',
                        '10:00',
                        '11:00',
                        '12:00',
                        '13:00',
                        '14:00',
                        '15:00',
                        '16:00',
                        '17:00',
                        '18:00'
                    ]
                },
                yAxis: {
                    title: {
                        text: ''
                    },
                    max: 1,
                    labels: {
                        enabled: false
                    },
                    gridLineWidth : 0
                },
                credits: {
                    enabled: false
                },
                plotOptions: {
                    areaspline: {
                        pointStart: -1,
                        fillOpacity: 0.5,
                        lineWidth: 4,
                        marker: {
                            enabled: false
                        }
                    }
                },
                tooltip: {
                    enabled: false
                },
                series: [{
                    name: 'old',
                    color: '#0084ff',
                    lineColor: {
                        linearGradient: { x1: 0.9, y1: 0, x2: 1, y2: 0},
                        stops: [
                            [0, 'rgba(0, 132, 255, 1)'],
                            [1, 'rgba(0, 132, 255, 0)']
                        ]
                    },
                    fillColor: {
                        linearGradient: { x1: 0.9, y1: 0, x2: 1, y2: 0},
                        stops: [
                            [0, 'rgba(0, 132, 255, 0.3)'],
                            [1, 'rgba(0, 132, 255, 0)']
                        ]
                    },
                    data: dataOld
                }, {
                    name: 'new',
                    color: '#45e630',
                    lineColor: {
                        linearGradient: { x1: 0.9, y1: 0, x2: 1, y2: 0},
                        stops: [
                            [0, 'rgba(69, 230, 48, 1)'],
                            [1, 'rgba(69, 230, 48, 0)']
                        ]
                    },
                    fillColor: {
                        linearGradient: { x1: 0.9, y1: 0, x2: 1, y2: 0},
                        stops: [
                            [0, 'rgba(69, 230, 48, 0.3)'],
                            [1, 'rgba(69, 230, 48, 0)']
                        ]
                    },
                    data: dataNew
                }]
            });
        }

    });
</script>
</body>
</html>