<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>10</title>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script type="text/javascript" src="../../js/geo.js"></script>
	<script type="text/javascript" src="../../js/gd.js"></script>
	<script type="text/javascript" src="../../js/ani.js"></script>
	<script type="text/javascript" src="../../js/map-painter.js"></script>
<style type="text/css">
html {
	overflow: hidden;
}
body{
	overflow: hidden;
	background-color: #333;
	font-family: "Microsoft YaHei", "微软雅黑", "黑体";
} 
canvas{
	position: absolute;
	left: 280px;
	top: 147px;
	/*width: 900px;*/
	/*height: 1400px;*/
	/*background-color: rgba(0,0,0,0.1);*/
}
.logo {
	height: 77px;
	width: 297px;
	background: url(../../img/logo3.png) no-repeat;
	color: transparent;
	text-indent: 86px;
	float: right;
	margin: 65px 70px 0 0;
	position: relative;
	z-index: 99999;
}
.full{
	position: absolute;
	left: 0px;
	/*right: 0px;*/
	top: 0px;
	/*bottom: 0px;*/
	width: 1920px;
	height: 1080px;
	background-image: url(image/bg5.jpg);
	background-size: 100% 100%;
	overflow: hidden;
}

#data{
	width: 430px;
	height: 448px;
	background: transparent url(image/data.png) left top no-repeat;
	position: absolute;
	left: 1420px;
	top: 200px;
}

.full > .button-bar{
	position: absolute;
	left: 70px;
	top: 180px;
	width: 185px;
	overflow: hidden;
	color: #fff;
	min-height: 150px;
	background: rgba(0,0,0,0) url(image/left-bar-bg.png) left bottom no-repeat;
	list-style: none;
	margin: 0px;
	padding: 10px;
	text-align: center;
	font-size: 20px;
}

.full > .button-bar > li{
	height: 130px;
	line-height: 130px;
	margin-top: 3px;
	background: rgba(17,50,124,0.8);
	border: 1px solid #0373e2;
	cursor: pointer;
	font-size: 32px;
}

.full > .button-bar > li.active{
	border: 5px solid #ffae00;
	background-color: #9d7930;
	font-weight: bold;
	font-size: 32px;
}

#data > .title{
	color: #fff;
	font-size: 24px;
	line-height: 90px;
	text-indent: 1em;
}

#china-map{
	width: 1245px;
	height: 886px;
	background: transparent url(image/china-map-m.png) left top no-repeat;
	background-size: 100% 100%;
	position: absolute;
	left: 290px;
	top: 154px;
}

.panel li h6, .panel li div, .panel ul, .panel li, .panel li em{
	margin: 0px;
	padding: 0px;
	overflow: hidden;
	list-style: none;
	display: block;
	font-style: normal;
}

.panel li div{
	height: 8px;
	border-radius: 3px;
	width: 120px;
	float: left;
	background-color: #1b3984;
	margin-top: 12px;
}
.panel li h6{
	background-color: #ffae00;
	height: 8px;
	width: 0%;
	border-radius: 3px;
}
.panel li em{
	float: left;
	width: 190px;
	height: 40px;
}

.panel > ul{
	padding: 35px 25px;
}

.panel > ul > li{
	height: 49px;
}

.panel{
	width: 380px;
	height: 361px;
	background-color: transparent;
	background-image: url(image/panel.png);
	background-size: 100% 100%;
	position: absolute;
	left: 1500px;
	top: 240px;
	color: #fff;
	font-size: 24px;
}

.panel > .title{
	height: 60px;
	line-height: 65px;
	padding-left: 26px;
	margin-top: 7px;
}



</style>
</head>
<body>

<div class="full">
	<div class="logo">万达商业年会</div>

	<div id="china-map"></div>
	<div id="canvas-container">
		<canvas id="cvs1" width="1200" height="1200"></canvas>
		<canvas id="cvs2" width="1200" height="1200"></canvas>
		<canvas id="cvs3" width="1200" height="1200"></canvas>
	</div>
	<menu class="button-bar">
		<li data="m1" class="active">元旦</li>
		<li data="m2">春节</li>
		<li data="m4">清明</li>
		<li data="m5">五一</li>
		<li data="m6">端午</li>
	</menu>
	<div class="panel p1">
		<div class="title">元旦</div>
		<ul class="content">
			<li><em></em><div><h6></h6></div></li>
			<li><em></em><div><h6></h6></div></li>
			<li><em></em><div><h6></h6></div></li>
			<li><em></em><div><h6></h6></div></li>
			<li><em></em><div><h6></h6></div></li>
		</ul>
	</div>

</div>


<script type="text/javascript">

var CITY = 'bj';
var MN = 'm1';
var CITYNAME = '';
var MAP = '../../json/china.json';
var DATA = '../../json/td/holiday_coordinate_bj_m1.json';
var DATA_ANI = [];

var GLOBAL = {
	"BASE_URL": '../../json/td/holiday_coordinate_',
	"cities": {
		"bj": { lng: 116.3, lat: 39.9, name: "北京" },
		"gz": { lng: 113.3, lat: 23.1, name: "广州" },
		"sh": { lng: 121.4, lat: 31.2, name: "上海" }
	},
	"maps": {
		"china": "../../json/china.json",
		"world": "../../json/world.json"
	}
};


function drawPoint(ctx, p, arg){
	// ctx.beginPath();
	// ctx.moveTo(p.x, p.y);
	// ctx.lineTo(p.x + 1, p.y);
	// ctx.fillStyle = "#ffffff";
	// ctx.lineWidth = 10;
	// ctx.lineCap = 'round';
	// ctx.stroke();

	ctx.beginPath();
	ctx.arc(p.x, p.y, arg.radio, 0, Math.PI * 2);
	ctx.fillStyle = arg.color;
	ctx.fill();
	// ctx.rect(100, 100, 200, 200);
	// ctx.fillStyle = '#fff';
	// ctx.fill();
	// GD.drawPoint(ctx, p, '#fff', 10);
	// GD.drawPoint(ctx, p, arg.color, arg.radio * 2)

}
function drawLines(ctx, path, arg, t){
	t = typeof(t) == 'number' ? t : 1;
	var i = 0;
	ctx.beginPath();
	ctx.moveTo(path[0].x, path[0].y);
	for(var i = 1; i < path.length; i++){
		ctx.lineTo(path[i].x, path[i].y);
	}
	ctx.lineWidth = arg.radio;
	ctx.strokeStyle = arg.color;
	ctx.stroke();
}


var painter = new MapPainter('#cvs1');
var painter2 = new MapPainter('#cvs2');
var painter3 = new MapPainter('#cvs3');

var bgFresh = Ani.addBase(function(){
	painter2.clear();
	painter3.clear();
	return -1;
});

var bgAni = false;

var M_INDEX = 0;
var MS = ['m1', 'm2', 'm4', 'm5', 'm6'];
var CITIES = ['bj', 'sh', 'gz'];
var CITY_INDEX = 0;

function DrawAll(){

	bgAni && bgAni.remove();

	painter.clear();
	painter.fitCanvas(10, 10, 10, 10);

	$.getJSON(MAP, function(data){
	
		var f = data.features.filter(function(a, i){
			return a.geometry;
		});
		painter.draw(f);
		painter.clear();

		var origin = painter.GetLonlatCoord(GLOBAL.cities[CITY]);
		bgAni = Ani.add(function(dur, DUR){
			for(var p in GLOBAL.cities){
				var P = painter.GetLonlatCoord(GLOBAL.cities[p]);
				painter3.drawPoint(P, 'rgba(255,130,0,1)', 10);	
				// painter3.drawPoint(P, 'rgba(255,255,255,1)', 6);
				// painter3.drawPoint(P, 'rgba(255,255,0,1)', 8);
				//todo 地图字体大小调整
				painter3.drawText(GLOBAL.cities[p].name, {
					x: P.x + 13,
					y: P.y + 4
				}, '#fff', '16px MicrosoftYaHei');
			}
			var t = dur / DUR;
			painter3.drawPoint(origin, 'rgba(255,0,0,1)', 10);
			painter3.drawPoint(origin, 'rgba(255,0,0,' + (1-t) + ')', 10 + Math.pow(t, 0.8) * 10);
			painter3.drawPoint(origin, 'rgba(255,0,0,' + (1-t) + ')', 10 + Math.pow(t, 0.5) * 10);
			painter3.drawPoint(origin, 'rgba(255,80,0,' + (1-t) + ')', 10 + t * 20);
			return -1;
		}, 2000);

		DrawData(origin);
		
	});
}

function DrawData(origin){

	GD.util.E(DATA_ANI, function(ani){
		ani.remove();
	});
	DATA_ANI = [];

	$.getJSON(DATA, function(data){
		var s = data.coordinates;
		// s = s.filter(function(a){
		// 	return a.distance < 5000;
		// });
		// s.sort(function(a, b){ return a.distance - b.distance; })
		var arg = {
			color: 'rgba(255,100,0,0.3)',
			radio: 2
		}, lineArg = {
			color: 'rgba(255,255,255,0.3)',
			radio: 1
		}, pArg = {
			color: 'rgba(255,255,255,0.1)',
			radio: 2
		}, bubbleArg = {
			color: 'rgba(255,255,0,0.1)',
			radio: 2
		};
		var D = 0;
		var POINTS = [];
		GD.util.E(s, function(S, i){
			S.lng = parseFloat(S.lng);
			S.lat = parseFloat(S.lat);
			var p = painter.GetLonlatCoord(S);
			p.distance = GD.distance(p, origin);
			p.S = S;
			POINTS.push(p);
			// painter.DrawLonlat(S, drawPoint, arg);
		});
		POINTS.sort(function(a, b){
			return a.distance - b.distance;
		});
		POINTS = POINTS.filter(function(a){
			return a.y > 300;
		});

		// POINTS = POINTS.slice(0, 3000);
		console.log(POINTS.length);
		// console.log(POINTS)
		// POINTS = POINTS.slice(0, 10)

		GD.util.E(POINTS, function(p, i){
			var d = p.distance * 10;
			var a = Ani.add(function(dur, DUR){
				if(p.S){
					painter.DrawLonlat(p.S, drawPoint, arg);
					p.S = false;
				}
				var t = dur / DUR;
				var t2 = t * 2;
				if(t2 > 1) t2 = 1 - t2;
				var color = 'rgba(255,255,255,' + (Math.sin(t * Math.PI) * .3) + ')';
				var color2 = 'rgba(255,255,255,' + (Math.sin(t * Math.PI) * 0.1) + ')';
				GD.CirclePathA(painter2.ctx, 30, origin, p, t2, color2, 1);
				// GD.drawLine(painter2.ctx, origin, p, t2, color2, 1)
				GD.drawPoint(painter2.ctx, p, color, 2);
				// return -1
			}, 1000, function(){
				
				if(i == POINTS.length - 1){
					if(CITY_INDEX < CITIES.length - 1){
						CITY_INDEX += 1;
						CITY = CITIES[CITY_INDEX];
						Init(CITY, MN);
						DrawAll();
					} else {
						CITY_INDEX = 0;
						CITY = CITIES[CITY_INDEX];
						M_INDEX = (M_INDEX + 1) % MS.length;

						$('.button-bar li').removeClass('active');
						$('.button-bar li[data="'+MS[M_INDEX]+'"]').addClass('active');
						$('.p1 .title').html($('.button-bar li[data="'+MS[M_INDEX]+'"]').html());

						Init(CITY, MS[M_INDEX]);
						DrawAll();
					}
					
					// GD.util.E(DATA_ANI, function(ani){
					// 	ani.restart();
					// });
				}
			}, i * 3, 2000);
			DATA_ANI.push(a);
		});
	});
}

function Init(city, m){

	CITY = city;
	MN = m;

	MN = MS[M_INDEX];

	console.log(MN)


	var c = $('.menu dl[city="'+CITY+'"] > dt');

	CITYNAME = $('.menu dl[city="'+CITY+'"] > dt').html();
	DATA = GLOBAL.BASE_URL + CITY + '_' + MN + '.json';

	$('.menu dl[city="'+CITY+'"]').addClass('active');
	$('.menu dl[city="'+CITY+'"] > dd[data="'+MN+'"]').addClass('active');
	// $('.p1 .title').html($('.menu dl[city="'+CITY+'"] > dd[data="'+MN+'"]').html());

	$.getJSON('../../json/td/holiday_city_'+CITY+'_'+MN+'.json', function(data){
		var sum = 0;
		data.forEach(function(a){sum+=a.ratio})
		data.sort(function(a, b){return b.ratio-a.ratio});
		console.log(data)
		//填充排行数据
		$('.p1 li').each(function(i){
			var li = $(this);
			li.children('em').html(data[i].city);
			li.children('div').children('h6').css({
				width: Math.round(data[i].ratio/sum * 100) + '%'
				, 'background-color': i < 3 ? '#ffae00' : '#2e77f1'
			});
		});
	})

	var city5 = COORD.slice(0, 5).sort(function(a, b){
		return 0.5 - Math.random();
	});

	var data = [Math.random() * 0.4, Math.random() * 0.3, Math.random() * 0.2, Math.random() * 0.1];
	var sum = 0;
	data.forEach(function(a){ sum += a ;});
	data.push(1 - sum);
	data.sort(function(a, b){return b - a});


	
}


var COORD = [
	[839.7432024169184, 334.380664652568, "北京"],
	[980.8912386706949, 545.1359516616315, "上海"],
	[841.6767371601209, 740.4229607250755, "广州"],
	[866.8126888217522, 357.58308157099697, "天津"],
	[688.9274924471299, 591.5407854984894, "重庆"],
	[634.7885196374622, 579.9395770392749, "成都"],
	[814.6072507552869, 460.0604229607251, "郑州"],
	[849.4108761329305, 361.4501510574018, "廊坊"],
	[857.1450151057402, 748.1570996978852, "深圳"],
	[955.7552870090634, 560.6042296072508, "杭州"],
	[948.0211480362537, 533.5347432024168, "常州"],
	[919.0181268882175, 525.8006042296072, "南京"],
	[841.6767371601209, 750.0906344410876, "佛山"],
	[839.7432024169184, 564.4712990936556, "武汉"]
];

// $('.button-bar li').click(function(e){
// 	console.log(arguments);
// 	$('.button-bar li').removeClass('active');
// 	$('.p1 .title').html($(this).html());
// 	var m = $(this).addClass('active').attr('data');
// 	Init(CITY = CITIES[CITY_INDEX], m);
// 	DrawAll();
// });
Init(CITY, MN);
DrawAll();

GD.fullFitDom('.full');


</script>

</body>
</html>