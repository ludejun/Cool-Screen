<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>02</title>
<script type="text/javascript" src="../../js/mt.js"></script>
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/geo.js"></script>
<script type="text/javascript" src="../../js/gd.js"></script>
<script type="text/javascript" src="../../js/ani.js"></script>
<script type="text/javascript" src="../../js/map-painter.js"></script>
<script type="text/javascript" src="js/main.js"></script>
<style type="text/css">
html {
	overflow: hidden;
}
body{
	overflow: hidden;
	background-color: #333;
}
canvas{
	display: block;
	
	/*background-color: #333;*/
	/*width: 1100px;*/
	/*height: 900px;*/
	/*transform-origin: 0px 0px;*/
	transform: rotateX(23deg);
	/*border: 2px solid #fff;*/
	background-color: rgba(0,0,0,0.1);
}
.full{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 1920px;
	height: 1080px;
	background-image: url(image/bg.jpg);
	overflow: hidden;

}

#cvsContainer{
	position: absolute;
	left: 520px;
	top: 130px;
	width: 1300px;
	height: 600px;
	perspective: 800;
	-webkit-perspective: 800;
	-moz-perspective: 800;
}

#time{
	width: 1571px;
	height: 50px;
	position: absolute;
	left: 50%;
	margin-left: -788px;
	bottom: 82px;
	color: #fff;
}

#time .grid{
	width: 0;
	height: 50px;
	transition: width 0.5s;
}

#time .grid.active{
	border: 5px solid #ffae00;
	background: rgba(255, 174, 0, 0.5);
	box-shadow: 0 0 20px #ffae00;
}
.hidden{
	display: none;
}
.logo {
	height: 77px;
	width: 297px;
	background: url(../../img/logo3.png) no-repeat;
	color: transparent;
	text-indent: 86px;
	float: right;
	margin: 65px 70px 0 0;
}
.header {
	overflow: hidden;
	position: absolute;
	left: 79px;
	top: 63px;
}
.header .title {
	font-family: FZLanTingHeiS-H-GB;
	width: 390px;
	height: 79px;
	background: url(../../img/title-bg.png);
	font-size: 44px;
	text-align: center;
	line-height: 89px;
	color: #fff;
	float: left;
}
</style>
</head>
<body>
<div class="full">
	<div class="header">
		<div class="title">现场动线</div>
	</div>
	<div class="logo">万达商业年会</div>
	<div id="cvsContainer">
		<canvas width="1300" height="700"></canvas>
	</div>
	<div id="time">
		<div class="grid active"></div>
	</div>
</div>


<script type="text/javascript">

var pageSize = 500;
var pageIndex = 0;
var timeArg = 100;
var ZOOMX = 14;
var ZOOMY = 14;
var trackBuffer = 4;
var pointSize = 8;

var COLORS = [];
var CIDX = 0;
for(var i = 0; i < 3; i++){
	for(var j = 64; j < 256; j+=16){
		var c = [255,255,255];
		c[i] = j;
		COLORS.push('rgba(' + c.join(',') + ',0.3)');
	}
}
COLORS.sort(function(){return 0.5-Math.random()})
// console.log(COLORS);

var canvas = document.querySelector('canvas');
var ctx = canvas.getContext('2d');

function eachData(data, fn){
	MT.EACH(data, function(v){
		MT.EACH(v.coordinates, function(p){
			fn(p);
		});
	});
};

GD.translateCenterCanvas(ctx);
ctx.rotate(Math.PI / 180 * 18);
// ctx.translate(-20 * ZOOMX, 130);
ctx.translate(0, 80);
var bgFresh = Ani.addBase(function(){
	ctx.clearRect(-2000, -2000, 6000, 6000);
	return -1;
});

function run(data){
	data = data.map(function(a){
		return { coordinates: a.map(function(aa){
			return { x: aa[0], y: aa[1] }
		}) }
	})

	var area = GD.dataRect(data, eachData);
	MT.EACH(data, function(v){
		MT.EACH(v.coordinates, function(p){
			p.x = area.center - parseFloat(p.x);
			p.y = area.middle - parseFloat(p.y);
		});
		v.coordinates.distance = Distance(v.coordinates);
	});


	Draw(data);

	$('.grid').removeClass('hidden');
}

var timeoutHandle = 0;
var times = [
	'T0800',
	'T0900',
	'T1000',
	'T1100',
	'T1200',
	'T1300',
	'T1400',
	'T1500',
	'T1600',
	'T1700',
	'T1800'
];

//刷新时间
var DELAY = 1000 * 60 * 10;

var index = 0;
function loadData(){
	var id = times[index];
	index = (index + 1) % times.length;
	clearTimeout(timeoutHandle);

	// $.getJSON('data/flowlinenew.json', function(data){
	$.get('http://54.222.253.178:9000/custom/flowlinenew?ts=' + Date.now(), function(data){
//	$.get('../../json/0803.json', function(data){
		// var data = cleanData(txt);
//		data = JSON.parse(data);

		run(data);

		timeoutHandle = setTimeout(Load, DELAY);

	}, 'json');
}

Load();

function Load(){
	clearTimeout(timeoutHandle);
	pageIndex = 0;
	Ani.clear(function(){
		loadData();
	});
}

function refreshTime() {
	var date = new Date();
	var now = date.getTime();
	date.setHours(9, 0, 0, 0);
	var start = date.getTime();
	date.setHours(18, 0, 0, 0);
	var end = date.getTime();
	if (now >= end) {
		now = end;
	}
	var p = (now - start) / (end - start) * 100;

	$('#time .grid').css({width: p + '%'});
}

refreshTime();
setInterval(function(){
	refreshTime();
}, 5 * 1000);

// run(JSON.parse(json))


// $('.grid').on('click', function(){
// 	clearTimeout(timeoutHandle);
// 	var id = this.id.substr(1);
// 	pageIndex = 0;
// 	Ani.clear(function(){
// 		loadData(id);
// 	});
// });

GD.fullFitDom('.full');




</script>


</body>
</html>