<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>墨卡托算法测试</title>
<script type="text/javascript" src="http://map-painter.mkjs.net/jquery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="http://map-painter.mkjs.net/js/geo.js"></script>
<script type="text/javascript" src="http://map-painter.mkjs.net/js/gd.js"></script>
<script type="text/javascript" src="http://map-painter.mkjs.net/js/ani.js"></script>
<script type="text/javascript" src="http://map-painter.mkjs.net/js/map-painter.js"></script>
<style type="text/css">
body{
	background-color: #000;
}
canvas{
	/*background-color: rgba(0,0,0,0.5);*/
	position: absolute;
	/*left: -1100px;*/
	top: -80px;
	/*top: -500px;*/
}
#cvs3{
	opacity: 1;
}
#canvas-container{
	position: absolute;
	left: 10px;
	top: 10px;
	width: 1200px;
	height: 700px;
	overflow: hidden;
	border: 1px solid #fff;
}

.world-map > canvas{
	left: -750px;
	top: -250px;
}

.menu{
	position: absolute;
	background-color: #fff;
	color: #000;
	left: 20px;
	top: 20px;
	cursor: pointer;
	width: 100px;
	font-size: 14px;
}
.menu dl{
	padding: 10px;
	margin: 0px;
}
.menu dl.active{
	background-color: #0af;
}
.menu dt, .menu dd{
	margin: 0px;
	padding: 0px;
	text-align: center;
	border: 1px solid #aaa;
	line-height: 1.6em;
	margin: 1px 0px;
}

.menu dt{
	border: 0px solid #aaa;
}
.menu dd{
	background-color: #fff;
}

.menu .active{
	background-color: #ff0;
}
dd[map]{
	font-size: 12px;
}

</style>
</head>
<body>

<div id="canvas-container">
	<canvas id="cvs1" width="1200" height="800"></canvas>
	<canvas id="cvs2" width="1200" height="800"></canvas>
	<canvas id="cvs3" width="1200" height="800"></canvas>
</div>

<div class="menu">
	<dl city="bj">
		<dt>北京</dt>
		<dd data="m1">m1</dd>
		<dd data="m2">m2</dd>
		<dd data="m4">m4</dd>
		<dd data="m5">m5</dd>
		<dd data="m6">m6</dd>
	</dl>
	<dl city="sh">
		<dt>上海</dt>
		<dd data="m1">m1</dd>
		<dd data="m2">m2</dd>
		<dd data="m4">m4</dd>
		<dd data="m5">m5</dd>
		<dd data="m6">m6</dd>
	</dl>
	<dl city="gz">
		<dt>广州</dt>
		<dd data="m1">m1</dd>
		<dd data="m2">m2</dd>
		<dd data="m4">m4</dd>
		<dd data="m5">m5</dd>
		<dd data="m6">m6</dd>
	</dl>
	<dl>
		<dt>地图</dt>
		<dd map="china" class="active">中国地图</dd>
		<dd map="world">世界地图</dd>
	</dl>
</div>

<script type="text/javascript">

var CITY = 'bj';
var MN = 'm1';
var CITYNAME = '';
var MAP = '/json/china.json';
var DATA = '';
var DATA_ANI = [];

var GLOBAL = {
	"BASE_URL": '../wanda/json/td/holiday_coordinate_',
	"cities": {
		"bj": { lng: 116.3, lat: 39.9, name: "北京" },
		"gz": { lng: 113.3, lat: 23.1, name: "广州" },
		"sh": { lng: 121.4, lat: 31.2, name: "上海" }
	},
	"maps": {
		"china": "/json/china.json",
		"world": "/json/world.json"
	}
};


function drawPoint(ctx, p, arg){
	GD.drawPoint(ctx, p, arg.color, arg.radio * 2)

}
function drawLines(ctx, path, arg, t){
	t = typeof(t) == 'number' ? t : 1;
	var i = 0;
	ctx.beginPath();
	ctx.moveTo(path[0].x, path[0].y);
	for(var i = 1; i < path.length; i++){
		ctx.lineTo(path[i].x, path[i].y);
	}
	ctx.lineWidth = arg.radio;
	ctx.strokeStyle = arg.color;
	ctx.stroke();
}


var painter = new MapPainter('#cvs1');
var painter2 = new MapPainter('#cvs2');
var painter3 = new MapPainter('#cvs3');

var bgFresh = Ani.addBase(function(){
	painter2.clear();
	painter3.clear();
	return -1;
});

var bgAni = false;


function DrawAll(){

	bgAni && bgAni.remove();

	painter.clear();
	painter.fitCanvas(100, 100, 100, 200);

	$.getJSON(MAP, function(data){
	
		var f = data.features.filter(function(a, i){
			return a.geometry;
		});
		painter.draw(f);

		var origin = painter.GetLonlatCoord(GLOBAL.cities[CITY]);
		bgAni = Ani.add(function(dur, DUR){
			for(var p in GLOBAL.cities){
				var P = painter.GetLonlatCoord(GLOBAL.cities[p]);
				painter3.drawPoint(P, 'rgba(255,0,0,1)', 10);
				painter3.drawPoint(P, 'rgba(255,255,255,1)', 6);
				// painter3.drawPoint(P, 'rgba(255,255,0,1)', 8);
				painter3.drawText(GLOBAL.cities[p].name, {
					x: P.x + 13,
					y: P.y + 4
				}, '#fff', '12px Arial');
			}
			var t = dur / DUR;
			painter3.drawPoint(origin, 'rgba(255,0,0,1)', 10);
			painter3.drawPoint(origin, 'rgba(255,0,0,' + (1-t) + ')', 10 + Math.pow(t, 0.8) * 10);
			painter3.drawPoint(origin, 'rgba(255,0,0,' + (1-t) + ')', 10 + Math.pow(t, 0.5) * 10);
			painter3.drawPoint(origin, 'rgba(255,80,0,' + (1-t) + ')', 10 + t * 20);
			return -1;
		}, 2000);

		DrawData(origin);
		
	});
}

function DrawData(origin){

	GD.util.E(DATA_ANI, function(ani){
		ani.remove();
	});
	DATA_ANI = [];

	$.getJSON(DATA, function(data){
		var s = data.coordinates;
		// s = s.filter(function(a){
		// 	return a.distance < 5000;
		// });
		// s.sort(function(a, b){ return a.distance - b.distance; })
		var arg = {
			color: 'rgba(255,100,0,0.3)',
			radio: 2
		}, lineArg = {
			color: 'rgba(255,255,255,0.3)',
			radio: 1
		}, pArg = {
			color: 'rgba(255,255,255,0.1)',
			radio: 2
		}, bubbleArg = {
			color: 'rgba(255,255,0,0.1)',
			radio: 2
		};
		var D = 0;
		var POINTS = [];
		GD.util.E(s, function(S, i){
			S.lng = parseFloat(S.lng);
			S.lat = parseFloat(S.lat);
			var p = painter.GetLonlatCoord(S);
			p.distance = GD.distance(p, origin);
			p.S = S;
			POINTS.push(p);
			// painter.DrawLonlat(S, drawPoint, arg);
		});
		POINTS.sort(function(a, b){
			return a.distance - b.distance;
		});
		POINTS = POINTS.filter(function(a){
			return a.y > 300;
		});
		console.log(POINTS.length);
		// console.log(POINTS)
		// POINTS = POINTS.slice(0, 10)

		GD.util.E(POINTS, function(p, i){
			var d = p.distance * 10;
			var a = Ani.add(function(dur, DUR){
				if(p.S){
					painter.DrawLonlat(p.S, drawPoint, arg);
					p.S = false;
				}
				var t = dur / DUR;
				var t2 = t * 2;
				if(t2 > 1) t2 = 1 - t2;
				var color = 'rgba(255,255,255,' + (Math.sin(t * Math.PI) * .3) + ')';
				var color2 = 'rgba(255,255,255,' + (Math.sin(t * Math.PI) * 0.1) + ')';
				GD.CirclePathA(painter2.ctx, 30, origin, p, t2, color2, 1);
				// GD.drawLine(painter2.ctx, origin, p, t2, color2, 1)
				GD.drawPoint(painter2.ctx, p, color, 2);
				// return -1
			}, 1000, function(){
				
				if(i == POINTS.length - 1){
					GD.util.E(DATA_ANI, function(ani){
						ani.restart();
					});
				}
			}, i * 3, 2000);
			DATA_ANI.push(a);
		});
	});
}

function Init(city, m){

	CITY = city;
	MN = m;

	var c = $('.menu dl[city="'+CITY+'"] > dt');

	CITYNAME = $('.menu dl[city="'+CITY+'"] > dt').html();
	DATA = GLOBAL.BASE_URL + CITY + '_' + MN + '.json';

	$('.menu dl[city="'+CITY+'"]').addClass('active');
	$('.menu dl[city="'+CITY+'"] > dd[data="'+MN+'"]').addClass('active');
}

Init(CITY, MN);
DrawAll();

$('.menu dd').click(function(e){
	var city = $(this.parentNode).attr('city');
	if(!city){
		$('.menu .active[map]').removeClass('active');
		var map = $(this).attr('map');
		MAP = GLOBAL.maps[map];

		switch(map){
			case 'world':
				$('canvas').attr('width', 2000).attr('height', 1500);
				$('#canvas-container').addClass('world-map');
				break;
			case 'china':
				$('canvas').attr('width', 1200).attr('height', 800);
				$('#canvas-container').removeClass('world-map');
				break;
		}
		painter.init();
		painter2.init();
		painter3.init();

		$(this).addClass('active');

		Init(CITY, MN);
		DrawAll();
	} else {
		$('.menu .active[city],.menu .active[data]').removeClass('active');
		var m = $(this).attr('data');
		Init(city, m);
		DrawAll();
	}
});












</script>

</body>
</html>