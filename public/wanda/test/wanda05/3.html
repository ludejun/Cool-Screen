<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>02</title>
<script type="text/javascript" src="../../jquery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../js/mt.js"></script>
<script type="text/javascript" src="../../js/ani.js"></script>
<script type="text/javascript" src="../../js/gd.js"></script>
<!-- <script type="text/javascript" src="../../js/geo.js"></script> -->

<style type="text/css">

body{
	/*overflow: hidden;*/
}
canvas{
	position: absolute;
	left: 535px;
	top: 120px;
	/*background-color: rgba(0,0,0,0.5);*/
}
.full{
	position: absolute;
	left: 0px;
	/*right: 0px;*/
	top: 0px;
	/*bottom: 0px;*/
	width: 1920px;
	height: 1080px;
	background-image: url(image/bg2.jpg);
	background-size: 100% 100%;
	overflow: hidden;
}

#data{
	width: 380px;
	height: 764px;
	background: transparent url(image/data.png) left top no-repeat;
	position: absolute;
	left: 80px;
	top: 180px;
}
</style>
</head>
<body>

<div class="full">
	<canvas width="1200" height="900"></canvas>
	<div id="data"></div>
</div>


<script type="text/javascript">

var canvas = document.querySelector('canvas');
var ctx = canvas.getContext('2d');

// ctx.translate(canvas.width * 0.5, canvas.height * 0.5);

var ZOOM = 1 / 28;

// ctx.fillStyle = '#fff';
// ctx.arc(0, 0, 100, 0, Math.PI * 2);
// ctx.fill();
// GD.translateCenterCanvas(ctx);

function drawLines(ctx, weight, p0, p1, t, color, aOffset, res){

	var delay = 0.02;
	var a = 3;
	var A = 40;

	// for(var i = 0; i <= weight / 2; i++){
		GD.CirclePathA(ctx, A, p0, p1, 1, color, weight);

	// }

	var cur = GD.CirclePointA(p0, p1, A, t);

	ctx.save();
	ctx.translate(cur.x, cur.y);
	ctx.rotate(cur.tangent + aOffset);

	var size = Math.pow(weight, 0.3) * 16;

	ctx.drawImage(res.plane
		, 0, 0, res.plane.width, res.plane.height
		, size * -.5, size * -.5, size, size
		);

	ctx.restore();

	
}

function drawOne(ctx, p, res){

	var DUR = 10000;
	var SIZE = 3;
	var TAIL = 10;
	var SPLIT = 0.5
	// var COLOR = 'rgba(100,200,255,0.5)';
	var COLOR = 'rgba(100,200,255,';

	var sign = [1, -1];
	var c = 0;
	var tail = [];

	var ani = Ani.add(function(dur){

		var t = dur / DUR / SPLIT;
		var aOffset = Math.PI * 0.5;
		if(t > 1){
			t = 2 - t;
			aOffset = Math.PI * -0.5;
		}
		var op = 0.5;
		var color = COLOR + op + ')';

		drawLines(ctx, p[2], p[0], p[1], t, color, aOffset, res);

		// var cur = GD.CirclePointA(p[0], p[1], 30, t);

		// GD.CirclePathA(ctx, 30, p[0], p[1], 1, color, 2);


		


	}, DUR, function(){
		// c = (c + 1) % 2;
		ani.restart();
	})
}

var bgFresh = Ani.addBase(function(){
	ctx.clearRect(-ctx.canvas.width, -ctx.canvas.height, ctx.canvas.width * 3, ctx.canvas.height * 3);
	return -1;
});

$.loadImage = function(src, fn){
	return $('<img>').one('load', function(e){
		typeof(fn) == 'function' && fn(this);
	}).attr('src', src);
};

$.loadImages = function(arr, fn){

	if(arr instanceof Array){
		var c = arr.length, r = [];
		for(var i = 0; i < arr.length; i++){
			$.loadImage(arr[i], function(img){
				r.push(img);
				if(--c <= 0){
					typeof(fn) == 'function' && fn(r);
				}
			});
		}
	} else if (arr instanceof Object){
		var keys = Object.keys(arr), c = keys.length, r = {};
		for(var i = 0; i < keys.length; i++){
			(function(key){
				$.loadImage(arr[key], function(img){
					r[key] = img;
					if(--c <= 0){
						typeof(fn) == 'function' && fn(r);
					}
				});
			})(keys[i]);
		}
	}
};

function eachData(data, fn){
	MT.EACH(data, function(v){
		fn(v[0]);
		fn(v[1]);
	});
};

var COORD = {
	"BEIJING": [825.3666540158112, 325.2428964252979],
	"SHANGHAI": [953.8359482412924, 552.2639780018332],
	"GUANGZHOU": [830.6462140524748, 737.0485792850595],
	"SHENZHEN": [756.7323735391842, 761.6865261228231],
	"KUNMING": [561.3886521826306, 687.7726856095326],
	"LASA": [357.2456640983043, 552.2639780018332],
	"CHANGCUN": [1003.1118419168195, 240.7699358386801],
	"HUHEHAOTE": [710.9761865547663, 319.9633363886343]
};

var DATA = {
	"BEIJING": {
		"SHANGHAI": 24,
		"GUANGZHOU": 18,
		"SHENZHEN": 12,
		"KUNMING": 6,
		"LASA": 5,
		"CHANGCUN": 3,
		"HUHEHAOTE": 2,
	},
};

$.loadImages({
	'plane': 'image/plane.png'
}, function(res){

	var key = "BEIJING";
	var cities = DATA[key];
	var data = [];

	var start = { x: COORD[key][0], y: COORD[key][1] };

	for(var p in cities){
		var pos = COORD[p];
		data.push([start, { x: pos[0], y: pos[1] }, cities[p]]);
	}

	console.log(data);

	MT.EACH(data, function(p){
		drawOne(ctx, p, res);
	})

});

GD.fullFitDom('.full');

// $(document).on('click', function(e){
// 	var offset = $('canvas').offset();
// 	var x = (e.clientX - offset.left) / GD.FIT_SCALE;
// 	var y = (e.clientY - offset.top) / GD.FIT_SCALE;

// 	var p = { x: x, y: y };

// 	GD.drawPoint(ctx, p, '#fff');

// 	console.log([x, y]);
// });

var A1 = Math.PI / 180;
var R = 6378137;

function Mercator(lat, lng, lat0){
	lat0 = lat0 || 0;
	lat = lat - lat0;

	lat *= A1;
	lng *= A1;

	var x = lat;
	var y = Math.log2(Math.tan(lng) + 1 / Math.cos(lng));

	return { x: x * R, y: y * R };

}

console.log(Mercator(116.46, 39.92));


</script>


</body>
</html>